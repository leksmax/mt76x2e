Index: mt76x2e-p4rev-113843/src/os/linux/cfg80211/cfg80211_util.c
===================================================================
--- mt76x2e-p4rev-113843.orig/src/os/linux/cfg80211/cfg80211_util.c
+++ mt76x2e-p4rev-113843/src/os/linux/cfg80211/cfg80211_util.c
@@ -28,6 +28,8 @@
 #include "rtmp_comm.h"
 #include "rtmp_osabl.h"
 #include "rt_os_util.h"
+#include "linux/nl80211.h"
+#include "linux/ieee80211.h"
 
 /* all available channels */
 UCHAR Cfg80211_Chan[] = {
@@ -949,6 +951,14 @@ void CFG80211OS_P2pClientConnectResultIn
 
 BOOLEAN CFG80211OS_RxMgmt(IN PNET_DEV pNetDev, IN INT32 freq, IN PUCHAR frame, IN UINT32 len) 
 {
+#if (LINUX_VERSION_CODE >= KERNEL_VERSION(3,18,0))
+        return cfg80211_rx_mgmt(pNetDev->ieee80211_ptr,
+                                freq,
+                                0,       //CFG_TODO return 0 in dbm
+                                frame,
+                                len,
+                                NL80211_RXMGMT_FLAG_ANSWERED);
+#else
 #if (LINUX_VERSION_CODE >= KERNEL_VERSION(3,12,0))
 	return cfg80211_rx_mgmt(pNetDev->ieee80211_ptr,
                                 freq,
@@ -987,7 +997,7 @@ BOOLEAN CFG80211OS_RxMgmt(IN PNET_DEV pN
 #endif /* LINUX_VERSION_CODE: 3.4.0 */
 #endif /* LINUX_VERSION_CODE: 3.6.0 */
 #endif /* LINUX_VERSION_CODE: 3.12.0 */
-
+#endif /* LINUX_VERSION_CODE: 3.18.0 */
 }
 
 VOID CFG80211OS_TxStatus(IN PNET_DEV pNetDev, IN INT32 cookie, IN PUCHAR frame, IN UINT32 len, IN BOOLEAN ack)
@@ -1076,4 +1086,4 @@ VOID CFG80211OS_RecvObssBeacon(VOID *pCB
 #endif /* LINUX_VERSION_CODE: 3.8.0 */
 }
 
-#endif /* RT_CFG80211_SUPPORT */
\ No newline at end of file
+#endif /* RT_CFG80211_SUPPORT */
Index: mt76x2e-p4rev-113843/src/os/linux/cfg80211/cfg80211.c
===================================================================
--- mt76x2e-p4rev-113843.orig/src/os/linux/cfg80211/cfg80211.c
+++ mt76x2e-p4rev-113843/src/os/linux/cfg80211/cfg80211.c
@@ -45,13 +45,13 @@
 
 #define RTMP_MODULE_OS
 
-#if (LINUX_VERSION_CODE >= KERNEL_VERSION(3,10,0))
-#include <linux/random.h>
-#endif
 #include "rtmp_comm.h"
 #include "rt_os_util.h"
 #include "rt_os_net.h"
 #include "rt_config.h"
+#if (LINUX_VERSION_CODE >= KERNEL_VERSION(3,10,0))
+#include <linux/random.h>
+#endif
 
 
 #if (LINUX_VERSION_CODE >= KERNEL_VERSION(2,6,28))
@@ -608,8 +608,11 @@ static int CFG80211_OpsStaGet(
 	{
 		pSinfo->txrate.flags = RATE_INFO_FLAGS_MCS;
 		if (StaInfo.TxRateFlags & RT_CMD_80211_TXRATE_BW_40)
+#if (LINUX_VERSION_CODE >= KERNEL_VERSION(4,0,0))
+                        pSinfo->txrate.bw = RATE_INFO_BW_40;
+#else
 			pSinfo->txrate.flags |= RATE_INFO_FLAGS_40_MHZ_WIDTH;
-
+#endif
 		if (StaInfo.TxRateFlags & RT_CMD_80211_TXRATE_SHORT_GI)
 			pSinfo->txrate.flags |= RATE_INFO_FLAGS_SHORT_GI;
 
@@ -621,8 +624,11 @@ static int CFG80211_OpsStaGet(
 		pSinfo->txrate.legacy = StaInfo.TxRateMCS;
 	} 
 
+#if (LINUX_VERSION_CODE >= KERNEL_VERSION(4,0,0))
+        pSinfo->filled |= BIT(NL80211_STA_INFO_TX_BITRATE);
+#else
 	pSinfo->filled |= STATION_INFO_TX_BITRATE;
-
+#endif
 	/* fill signal */
 	pSinfo->signal = StaInfo.Signal;
 	pSinfo->filled |= STATION_INFO_SIGNAL;
@@ -1258,11 +1264,16 @@ static int CFG80211_OpsSurveyGet(
 
 	/* return the information to upper layer */
 	pSurvey->channel = ((CFG80211_CB *)(SurveyInfo.pCfg80211))->pCfg80211_Channels;
+#if (LINUX_VERSION_CODE >= KERNEL_VERSION(4,0,0))
+        pSurvey->filled = SURVEY_INFO_TIME_BUSY | SURVEY_INFO_TIME_EXT_BUSY;
+        pSurvey->time_busy = SurveyInfo.ChannelTimeExtBusy; /* unit: us */
+        pSurvey->time_ext_busy = SurveyInfo.ChannelTimeExtBusy;
+#else
 	pSurvey->filled = SURVEY_INFO_CHANNEL_TIME_BUSY |
 						SURVEY_INFO_CHANNEL_TIME_EXT_BUSY;
 	pSurvey->channel_time_busy = SurveyInfo.ChannelTimeBusy; /* unit: us */
 	pSurvey->channel_time_ext_busy = SurveyInfo.ChannelTimeExtBusy;
-
+#endif
 	CFG80211DBG(RT_DEBUG_TRACE, ("80211> busy time = %ld %ld\n",
 				(ULONG)SurveyInfo.ChannelTimeBusy,
 				(ULONG)SurveyInfo.ChannelTimeExtBusy));
Index: mt76x2e-p4rev-113843/src/include/cfg80211.h
===================================================================
--- mt76x2e-p4rev-113843.orig/src/include/cfg80211.h
+++ mt76x2e-p4rev-113843/src/include/cfg80211.h
@@ -36,7 +36,11 @@ typedef enum _NDIS_HOSTAPD_STATUS {
 typedef struct __CFG80211_CB {
 
 	/* we can change channel/rate information on the fly so we backup them */
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(4,7,0)
+	struct ieee80211_supported_band Cfg80211_bands[NUM_NL80211_BANDS];
+#else
 	struct ieee80211_supported_band Cfg80211_bands[IEEE80211_NUM_BANDS];
+#endif
 	struct ieee80211_channel *pCfg80211_Channels;
 	struct ieee80211_rate *pCfg80211_Rates;
 
